<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì—¬í–‰ ê²½ë¹„ ì •ì‚°</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#9fb0c3; --text:#e7f0fb; --acc:#5cc8ff; --acc2:#7bf1a8; --danger:#ff6b6b;
      --bd: #223044; --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:linear-gradient(180deg,#0b0f14 0%,#0e141c 100%);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:16px;padding-bottom:96px}
    header{position:sticky;top:0;backdrop-filter:saturate(180%) blur(10px);background:rgba(11,15,20,.65);z-index:10;border-bottom:1px solid var(--bd)}
    header .inner{max-width:820px;margin:0 auto;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:var(--shadow)}
    h1{font-size:18px;margin:0}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);background:linear-gradient(180deg,#121a24,#121821);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent}
    .btn.primary{background:linear-gradient(180deg,#1a2a3e,#132135);border-color:#29405e}
    .btn.danger{background:linear-gradient(180deg,#2b1111,#1a0d0d);border-color:#4b1e1e;color:#ffd7d7}
    .btn.small{padding:6px 8px;border-radius:10px;font-size:12px}
    .btn.block{display:flex;width:100%;justify-content:center}
    .grid{display:grid;gap:12px}
    .card{background:linear-gradient(180deg,#0f1620,#101823);border:1px solid var(--bd);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--bd);background:#0c131c;color:var(--text)}
    input[type="date"]{padding:10px 12px}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--bd);cursor:pointer;background:#0f1620}
    .chip.active{outline:2px solid var(--acc);outline-offset:2px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:center;justify-content:space-between;background:rgba(255,255,255,.02);border:1px dashed var(--bd);border-radius:14px;padding:10px}
    .muted{color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px;background:#0f1620}
    .pill{padding:4px 10px;border-radius:999px;background:linear-gradient(135deg,rgba(92,200,255,.18),rgba(123,241,168,.15));border:1px solid #2e4d63;color:#cfefff}
    .kicker{font-size:12px;color:var(--muted)}
    .amount{font-variant-numeric:tabular-nums}

    .fab{position:fixed;right:16px;bottom:16px;z-index:20}
    .safe{position:fixed;left:16px;bottom:16px;font-size:12px;color:var(--muted)}

    .bottom-bar{position:fixed;bottom:0;left:0;right:0;backdrop-filter:saturate(180%) blur(10px);background:rgba(11,15,20,.85);border-top:1px solid var(--bd);z-index:15}
    .bottom-bar .inner{max-width:820px;margin:0 auto;padding:10px 16px;display:flex;gap:10px}

    .divider{height:1px;background:linear-gradient(90deg,transparent,#213148,transparent);margin:14px 0}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}
    .nowrap{white-space:nowrap}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:40}
    .modal{max-width:760px;width:100%;padding:10px}

    @media (min-width:720px){
      .grid.cols-2{grid-template-columns:1fr 1fr}
      .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="brand">
        <div class="logo"></div>
        <h1>ì—¬í–‰ ê²½ë¹„ ì •ì‚°</h1>
      </div>
      <div class="row">
        <button class="btn small ghost" id="btnAllTrips" type="button">ì—¬í–‰ ëª©ë¡</button>
        <button class="btn small" id="btnShare" title="ìš”ì•½ ê³µìœ " type="button">ìš”ì•½ ê³µìœ </button>
        <button class="btn small" id="btnChatShare" title="ì¹´ì¹´ì˜¤/ë¬¸ì ì „ìš©" type="button">ì¹´ì¹´ì˜¤/ë¬¸ì</button>
        <button class="btn small" id="btnSheet" title="êµ¬ê¸€ì‹œíŠ¸" type="button">êµ¬ê¸€ì‹œíŠ¸</button>
        <button class="btn small ghost" id="btnExport" title="ë°±ì—…/ë‚´ë³´ë‚´ê¸°" type="button">JSON ë‚´ë³´ë‚´ê¸°</button>
        <label for="importJson" class="btn small ghost" title="ë³µì›/ë¶ˆëŸ¬ì˜¤ê¸°" style="cursor:pointer">JSON ë¶ˆëŸ¬ì˜¤ê¸°<input id="importJson" type="file" accept="application/json" hidden></label>
        <button class="btn small ghost" id="btnRunTests" title="ë‚´ì¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰" type="button">í…ŒìŠ¤íŠ¸</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div id="screenTrips" class="grid"></div>
    <div id="screenTrip" class="grid" style="display:none"></div>
  </div>

  <div class="fab">
    <button class="btn primary" id="btnAdd" type="button">+ ìƒˆ í•­ëª©</button>
  </div>

  <div class="safe">ë°ì´í„°ëŠ” ì´ ê¸°ê¸°(LocalStorage)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>

  <div class="bottom-bar">
    <div class="inner">
      <button class="btn block" id="btnCopy" type="button">ìš”ì•½ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
      <button class="btn block" id="btnCopyChat" type="button">ì¹´ì¹´ì˜¤/ë¬¸ì ë³µì‚¬</button>
    </div>
  </div>

<script>
// ===== ë°ì´í„° ëª¨ë¸ & ì €ì¥ =====
const VERSION = 1;
const STORAGE_KEY = 'travelSplitData_v1';

const App = {
  state: { version: VERSION, trips: [] },
  currentTripId: null,
};

function uid(){return Math.random().toString(36).slice(2,10)}

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){save(); return}
    App.state = JSON.parse(raw);
    if(!App.state.version){App.state.version = VERSION}
  }catch(e){console.error(e); save()}
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(App.state)) }

// ===== ìœ í‹¸ =====
// UI í‘œì‹œëŠ” ì› ë‹¨ìœ„(ì†Œìˆ˜ì  ì—†ìŒ), ìš”ì•½/ë¬¸ììš©ì€ í†µí™” ë‹¨ìœ„ ì—†ì´ ìˆ«ìë§Œ
const fmt = (n, currency) => `${Number(n).toLocaleString(undefined,{maximumFractionDigits:0, minimumFractionDigits:0})}${currency? ' ' + currency: ''}`;
const fmtPlain = (n) => Number(n).toLocaleString(undefined,{maximumFractionDigits:0, minimumFractionDigits:0});
function sum(arr){ return arr.reduce((a,b)=>a+ (Number(b)||0), 0) }
function tripDisplayName(t){ return `${t.start? t.start + '_' : ''}${t.name||'ë¬´ì œ'}`; }

// ===== ë Œë”: ì—¬í–‰ ëª©ë¡ =====
function renderTrips(){
  const root = document.getElementById('screenTrips');
  const detail = document.getElementById('screenTrip');
  root.style.display='grid'; detail.style.display='none';
  root.innerHTML = '';

  const headerCard = document.createElement('div');
  headerCard.className = 'card';
  const typeOptions = Array.from(new Set(App.state.trips.map(t=>t.type).filter(Boolean).concat(['êµ­ë‚´','í•´ì™¸','ê°€ì¡±','ì¹œêµ¬','ì»¤í”Œ','ì—…ë¬´'])));
  headerCard.innerHTML = `
    <div class="row wrap" style="justify-content:space-between;gap:10px">
      <div>
        <h3>ì—¬í–‰ ì „ì²´ ëª©ë¡</h3>
        <div class="kicker">ì—¬í–‰ì„ ì¶”ê°€í•˜ê³ , ìœ í˜•ë³„ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.</div>
      </div>
      <div class="row">
        <input list="typeList" id="filterType" placeholder="ìœ í˜•(ì„ íƒ)" />
        <button class="btn small ghost" id="btnTypeMenu" title="ìœ í˜• ëª©ë¡ ì—´ê¸°" type="button">â–¼</button>
        <button class="btn small ghost" id="btnTypeClear" title="ìœ í˜• ì´ˆê¸°í™”" type="button">âœ•</button>
        <datalist id="typeList">${typeOptions.map(x=>`<option value="${x}"></option>`).join('')}</datalist>
        <input id="searchTrip" placeholder="ì—¬í–‰ ì´ë¦„ ê²€ìƒ‰" />
        <button class="btn" id="btnNewTrip" type="button">+ ìƒˆ ì—¬í–‰</button>
      </div>
    </div>`;
  root.appendChild(headerCard);

  const list = document.createElement('div');
  list.className = 'list';
  const q = headerCard.querySelector('#searchTrip');
  const typeSel = headerCard.querySelector('#filterType');

  function draw(){
    list.innerHTML='';
    let trips = [...App.state.trips];
    const keyword = (q.value||'').trim().toLowerCase();
    const type = (typeSel.value||'').trim();
    if(type){ const tl = type.toLowerCase(); trips = trips.filter(t=> (t.type||'').toLowerCase().includes(tl)) }
    if(keyword){ trips = trips.filter(t=> (t.name||'').toLowerCase().includes(keyword)) }

    if(trips.length===0){
      const empty = document.createElement('div');
      empty.className='empty';
      empty.textContent='ì•„ì§ ì—¬í–‰ì´ ì—†ìŠµë‹ˆë‹¤. "+ ìƒˆ ì—¬í–‰"ìœ¼ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”.';
      list.appendChild(empty);
    }else{
      trips.forEach(t=>{
        const stats = calcTripStats(t);
        const total = stats.totalAmount;
        const unsettled = stats.settlements.length>0;
        const item = document.createElement('div');
        item.className='item';
        item.innerHTML = `
          <div>
            <div class="row" style="gap:8px;align-items:baseline">
              <strong>${escapeHTML(tripDisplayName(t))}</strong>
              ${t.type? `<span class="badge">${t.type}</span>`:''}
              ${t.currency? `<span class="badge">í†µí™” ${t.currency}</span>`:''}
            </div>
            <div class="kicker">ì°¸ê°€ì ${t.people.length}ëª… Â· ì´ì•¡ <span class="amount">${fmt(total, t.currency)}</span> Â· ${t.expenses.length}ê±´</div>
          </div>
          <div class="row">
            ${unsettled? `<span class="pill">ì •ì‚° í•„ìš”</span>`:`<span class="badge">ì •ì‚° ì™„ë£Œ</span>`}
            <button class="btn small" data-id="${t.id}" type="button">ì—´ê¸°</button>
            <button class="btn small ghost" data-del="${t.id}" type="button">ì‚­ì œ</button>
          </div>`;
        // ì•ˆì •ì„±: ê° ë²„íŠ¼ì— ì§ì ‘ í•¸ë“¤ëŸ¬ ë°”ì¸ë”© (ì¼ë¶€ í™˜ê²½ confirm ì°¨ë‹¨ ëŒ€ì‘)
        const openBtn = item.querySelector('[data-id]');
        const delBtn = item.querySelector('[data-del]');
        openBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); openTrip(t.id); });
        delBtn.addEventListener('click', async (ev)=>{ ev.stopPropagation(); await deleteTrip(t.id); });
        list.appendChild(item);
      })
    }
  }
  draw();
  typeSel.addEventListener('input', draw);
  typeSel.addEventListener('change', draw);
  q.addEventListener('input', draw);

  // ìœ í˜• ë“œë¡­ë‹¤ìš´(ì „ì²´ ëª©ë¡ ê°•ì œ í‘œì‹œ)
  const menuBtn = headerCard.querySelector('#btnTypeMenu');
  const clearBtn = headerCard.querySelector('#btnTypeClear');
  clearBtn.onclick = ()=>{ typeSel.value=''; draw(); typeSel.focus(); }
  menuBtn.onclick = (ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    const rect = menuBtn.getBoundingClientRect();
    const menu = document.createElement('div');
    menu.className='card';
    Object.assign(menu.style, {position:'fixed', top:(rect.bottom+6)+'px', left: Math.min(rect.left, window.innerWidth-220)+'px', width:'200px', maxHeight:'260px', overflow:'auto', zIndex:1000});
    const all = document.createElement('div'); all.className='item'; all.innerHTML='<div>ëª¨ë‘</div>'; all.style.cursor='pointer'; all.onclick=()=>{ typeSel.value=''; draw(); close(); typeSel.focus(); };
    menu.appendChild(all);
    typeOptions.forEach(v=>{
      const it = document.createElement('div'); it.className='item'; it.style.cursor='pointer'; it.innerHTML = `<div>${escapeHTML(v)}</div>`;
      it.onclick=()=>{ typeSel.value=v; draw(); close(); typeSel.focus(); };
      menu.appendChild(it);
    });
    document.body.appendChild(menu);
    function close(){ menu.remove(); document.removeEventListener('click', onDoc, true); }
    function onDoc(e){ if(!menu.contains(e.target) && e.target!==menuBtn) close(); }
    setTimeout(()=> document.addEventListener('click', onDoc, true), 0);
  };

  // ë³´ì¡°: ìœ„ì„ ë°©ì‹ë„ ìœ ì§€(í…ìŠ¤íŠ¸ ë…¸ë“œ íƒ€ê¹ƒ ëŒ€ë¹„)
  list.addEventListener('click', async (ev)=>{
    const target = ev.target instanceof Element ? ev.target : ev.target.parentElement;
    if(!target) return;
    const delBtn = target.closest('[data-del]');
    if(delBtn && list.contains(delBtn)){ await deleteTrip(delBtn.getAttribute('data-del')); return; }
    const openBtn = target.closest('[data-id]');
    if(openBtn && list.contains(openBtn)){ openTrip(openBtn.getAttribute('data-id')); }
  });

  root.appendChild(list);

  headerCard.querySelector('#btnNewTrip').onclick = ()=>{
    const id = uid();
    App.state.trips.push({id, name:'ìƒˆ ì—¬í–‰', type:'', currency:'KRW', start:'', end:'', people:[], expenses:[]});
    save();
    openTrip(id);
  }
}

function removeTripById(state, id){
  return { ...state, trips: state.trips.filter(t=>t.id!==id) };
}

async function deleteTrip(id){
  const ok = await askConfirm('ì´ ì—¬í–‰ì„ ì‚­ì œí• ê¹Œìš”? ë‹¤ì‹œ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'ì‚­ì œ', 'ì·¨ì†Œ');
  if(!ok) return;
  const idx = App.state.trips.findIndex(x=>x.id===id);
  if(idx>-1){ App.state.trips.splice(idx,1); }
  if(App.currentTripId===id){ App.currentTripId = App.state.trips[0]?.id || null; }
  save();
  renderTrips();
}

// ===== ë Œë”: ì—¬í–‰ ìƒì„¸ =====
function openTrip(id){
  App.currentTripId = id;
  const t = App.state.trips.find(x=>x.id===id);
  if(!t) return;
  const root = document.getElementById('screenTrip');
  const list = document.getElementById('screenTrips');
  list.style.display='none'; root.style.display='grid';
  root.innerHTML='';

  const top = document.createElement('div');
  top.className='card';
  const typeOptions = Array.from(new Set(App.state.trips.map(t=>t.type).filter(Boolean).concat(['êµ­ë‚´','í•´ì™¸','ê°€ì¡±','ì¹œêµ¬','ì»¤í”Œ','ì—…ë¬´'])));
  top.innerHTML = `
    <div class="grid cols-3">
      <div>
        <label>ì—¬í–‰ ì´ë¦„</label>
        <input id="tName" value="${escapeAttr(t.name||'')}" placeholder="ì˜ˆ: ì œì£¼ë„ 3ë°•4ì¼" />
      </div>
      <div>
        <label>ì—¬í–‰ ìœ í˜• (ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)</label>
        <input id="tType" list="tTypeList" value="${escapeAttr(t.type||'')}" placeholder="ì˜ˆ: ê°€ì¡±, ì¹œêµ¬, ì—…ë¬´" />
        <datalist id="tTypeList">${typeOptions.map(x=>`<option value="${x}"></option>`).join('')}</datalist>
      </div>
      <div>
        <label>í†µí™”</label>
        <input id="tCurrency" value="${escapeAttr(t.currency||'KRW')}" placeholder="KRW" />
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:10px">
      <div>
        <label>ì¶œë°œì¼</label>
        <input type="date" id="tStart" value="${t.start||''}" />
      </div>
      <div>
        <label>ë³µê·€ì¼</label>
        <input type="date" id="tEnd" value="${t.end||''}" />
      </div>
      <div class="row" style="align-items:flex-end">
        <button class="btn" id="btnSaveTrip" type="button">ë³€ê²½ ì €ì¥</button>
      </div>
    </div>`;
  root.appendChild(top);

  // ì°¸ê°€ì ì¹´ë“œ
  const peopleCard = document.createElement('div');
  peopleCard.className='card';
  peopleCard.innerHTML = `
    <h3>ì°¸ê°€ì</h3>
    <div id="peopleList" class="chips" style="margin-bottom:10px"></div>
    <div class="row">
      <input id="newPerson" placeholder="ì´ë¦„ ì…ë ¥ í›„ ì¶”ê°€" enterkeyhint="done" />
      <button class="btn" id="btnAddPerson" type="button">+ ì¶”ê°€</button>
    </div>
    <div class="hint" style="margin-top:8px">ì´ë¦„ì„ íƒ­í•˜ë©´ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
  `;
  root.appendChild(peopleCard);

  // ì§€ì¶œ ì¹´ë“œ
  const expCard = document.createElement('div');
  expCard.className='card';
  expCard.innerHTML = `
    <h3>ì§€ì¶œ</h3>
    <div id="expList" class="list"></div>
    <div class="divider"></div>
    <h3>ìƒˆ ì§€ì¶œ ì¶”ê°€</h3>
    <div class="grid cols-3">
      <div>
        <label>ë‚ ì§œ</label>
        <input type="date" id="eDate" />
      </div>
      <div>
        <label>í•­ëª©</label>
        <input id="eTitle" placeholder="ì˜ˆ: ì €ë…ì‹ì‚¬" />
      </div>
      <div>
        <label>ê¸ˆì•¡ (${t.currency||'KRW'})</label>
        <input id="eAmount" inputmode="decimal" placeholder="0" />
      </div>
      <div style="grid-column:1 / -1">
        <label>ë©”ëª¨ (ì„ íƒ)</label>
        <textarea id="eMemo" rows="2" placeholder="ì¥ì†Œ, ì˜ìˆ˜ì¦ ë²ˆí˜¸, ë¹„ê³  ë“±"></textarea>
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:10px">
      <div>
        <label>ì§€ë¶ˆì</label>
        <select id="ePayer">${t.people.map(p=>`<option value="${p.id}">${escapeHTML(p.name)}</option>`).join('')}</select>
      </div>
      <div class="colspan-2">
        <label>ì‚¬ìš©í•œ ì‚¬ëŒ / ë¶„ë°° ëŒ€ìƒ (ì—¬ëŸ¬ ëª… ì„ íƒ)</label>
        <div id="eUsers" class="chips"></div>
      </div>
    </div>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div class="hint">ê¸°ë³¸ì€ ê· ë“± ë¶„ë°°ì…ë‹ˆë‹¤.</div>
      <button class="btn" id="btnAddExpense" type="button">+ ì§€ì¶œ ì¶”ê°€</button>
    </div>
  `;
  root.appendChild(expCard);
  // ìƒˆ ì§€ì¶œ ì…ë ¥ì˜ ë‚ ì§œ ê¸°ë³¸ê°’ = ì¶œë°œì¼
  if(t.start){ const d = expCard.querySelector('#eDate'); if(d) d.value = t.start; }

  // ìš”ì•½ ì¹´ë“œ
  const sumCard = document.createElement('div');
  sumCard.className='card';
  sumCard.innerHTML = `
    <h3>ìš”ì•½</h3>
    <div id="summary"></div>
  `;
  root.appendChild(sumCard);
  enableAutoShowDatePickers(root);

  // ë™ì‘ ë°”ì¸ë”©
  top.querySelector('#btnSaveTrip').onclick = ()=>{
    t.name = top.querySelector('#tName').value.trim()||'ë¬´ì œ';
    t.type = top.querySelector('#tType').value;
    t.currency = top.querySelector('#tCurrency').value.trim()||'KRW';
    t.start = top.querySelector('#tStart').value; t.end = top.querySelector('#tEnd').value;
    save(); openTrip(t.id);
  };

  function drawPeople(){
    const cont = peopleCard.querySelector('#peopleList');
    cont.innerHTML='';
    if(!t.people) t.people=[];
    t.people.forEach(p=>{
      const chip = document.createElement('div');
      chip.className='chip'; chip.textContent = p.name;
      chip.title='íƒ­í•˜ì—¬ ì‚­ì œ';
      chip.onclick = async ()=>{
        const ok = await askConfirm(`ì°¸ê°€ì "${p.name}" ë° ê´€ë ¨ ì§€ì¶œì„ ì‚­ì œí• ê¹Œìš”?`, 'ì‚­ì œ', 'ì·¨ì†Œ');
        if(!ok) return;
        // remove from expenses references
        t.expenses = t.expenses.map(e=>({
          ...e,
          paidBy: e.paidBy===p.id? (t.people.find(x=>x.id!==p.id)?.id || null) : e.paidBy,
          users: e.users.filter(id=>id!==p.id)
        })).filter(e=> e.paidBy!==null && e.users.length>0);
        t.people = t.people.filter(x=>x.id!==p.id);
        save(); openTrip(t.id);
      }
      cont.appendChild(chip);
    });
  }
  drawPeople();

  const newPersonInput = peopleCard.querySelector('#newPerson');
  const addPerson = ()=>{
    const name = newPersonInput.value.trim();
    if(!name) return;
    t.people.push({id:uid(), name});
    newPersonInput.value='';
    save(); openTrip(t.id);
  };
  peopleCard.querySelector('#btnAddPerson').onclick = addPerson;
  // Enter í‚¤ë¡œ ì°¸ê°€ì ì¶”ê°€ (IME ì¡°í•© ì…ë ¥ ì¤‘ EnterëŠ” ë¬´ì‹œ)
  newPersonInput.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.isComposing){ e.preventDefault(); addPerson(); }
  });

  function drawExpenseUsers(selectedIds=null){
    const wrap = expCard.querySelector('#eUsers');
    wrap.innerHTML='';
    const set = selectedIds ? new Set(selectedIds) : new Set((t.people||[]).map(p=>p.id));
    (t.people||[]).forEach(p=>{
      const c = document.createElement('div');
      c.className='chip'; c.textContent=p.name; c.dataset.id=p.id;
      if(set.has(p.id)) c.classList.add('active');
      c.onclick=()=>{c.classList.toggle('active')};
      wrap.appendChild(c);
    })
  }
  // ê¸°ë³¸: ì°¸ê°€ì ì „ì› ì„ íƒ
  drawExpenseUsers(null);

  function drawExpenses(){
    const list = expCard.querySelector('#expList');
    list.innerHTML='';
    if(!t.expenses || t.expenses.length===0){
      const empty = document.createElement('div'); empty.className='empty'; empty.textContent='ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤.'; list.appendChild(empty);
    }else{
      t.expenses.forEach(e=>{
        const payer = t.people.find(p=>p.id===e.paidBy);
        const users = e.users.map(id=> t.people.find(p=>p.id===id)?.name).filter(Boolean).join(', ');
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `
          <div>
            <div><strong>${escapeHTML(e.title)}</strong> Â· <span class="amount">${fmt(e.amount, t.currency)}</span></div>
            <div class="kicker">${e.date||''} Â· ì§€ë¶ˆì ${escapeHTML(payer?.name||'')} Â· ì‚¬ìš©: ${escapeHTML(users)}</div>
            ${e.memo? `<div class="kicker">ğŸ“ ${escapeHTML(e.memo)}</div>`:''}
          </div>
          <div class="row">
            <button class="btn small" data-edit="${e.id}" type="button">ìˆ˜ì •</button>
            <button class="btn small ghost" data-del-exp="${e.id}" type="button">ì‚­ì œ</button>
          </div>`;
        list.appendChild(item);
        // ì§€ì¶œ í•­ëª© ì‚­ì œ/ìˆ˜ì • (ê°œë³„ ë°”ì¸ë”©)
        item.querySelector('[data-del-exp]').onclick = async ()=>{
          const ok = await askConfirm('ì´ ì§€ì¶œì„ ì‚­ì œí• ê¹Œìš”?', 'ì‚­ì œ', 'ì·¨ì†Œ');
          if(!ok) return;
          t.expenses = t.expenses.filter(x=>x.id!==e.id); save(); openTrip(t.id);
        }
        item.querySelector('[data-edit]').onclick = ()=> openExpenseEditor(t, e.id);
      })
    }
  }
  drawExpenses();

  expCard.querySelector('#btnAddExpense').onclick = ()=>{
    const date = expCard.querySelector('#eDate').value;
    const title = expCard.querySelector('#eTitle').value.trim();
    const amount = parseFloat(expCard.querySelector('#eAmount').value);
    const paidBy = expCard.querySelector('#ePayer').value;
    const users = [...expCard.querySelectorAll('#eUsers .chip.active')].map(x=>x.dataset.id);
    const memo = expCard.querySelector('#eMemo').value.trim();
    if(!title || !amount || !paidBy || users.length===0){ alert('í•­ëª©/ê¸ˆì•¡/ì§€ë¶ˆì/ì‚¬ìš©ì(ë¶„ë°° ëŒ€ìƒ)ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return }
    t.expenses.push({id:uid(), date, title, amount, paidBy, users, memo});
    expCard.querySelector('#eTitle').value=''; expCard.querySelector('#eAmount').value=''; expCard.querySelector('#eMemo').value='';
    // ê¸°ë³¸ê°’: ì¶œë°œì¼ë¡œ ë‚ ì§œ ì¬ì„¤ì •, ë¶„ë°°ëŒ€ìƒ ì „ì› ì„ íƒìœ¼ë¡œ ì´ˆê¸°í™”
    if(t.start){ expCard.querySelector('#eDate').value = t.start; } else { expCard.querySelector('#eDate').value = ''; }
    drawExpenseUsers(null);
    save(); openTrip(t.id);
  }

  // ìš”ì•½ ë Œë”
  function drawSummary(){
    const s = calcTripStats(t);
    const el = sumCard.querySelector('#summary');
    const currency = t.currency||'KRW';
    el.innerHTML = '';

    const totals = document.createElement('div');
    totals.className='grid cols-3';
    totals.innerHTML = `
      <div class="card" style="background:#0e1722"><div class="kicker">ì´ì•¡</div><div style="font-size:18px" class="amount">${fmt(s.totalAmount, currency)}</div></div>
      <div class="card" style="background:#0e1722"><div class="kicker">1ì¸ í‰ê· (ì‚¬ìš©ì ê¸°ì¤€)</div><div style="font-size:18px" class="amount">${fmt(s.avgPerUser, currency)}</div></div>
      <div class="card" style="background:#0e1722"><div class="kicker">ì§€ì¶œ ê±´ìˆ˜</div><div style="font-size:18px">${t.expenses.length}ê±´</div></div>`;
    el.appendChild(totals);

    // ê°œì¸ë³„ ì •ì‚°í‘œ
    const table = document.createElement('div');
    table.className='list';
    s.balances.forEach(b=>{
      const item = document.createElement('div'); item.className='item';
      const status = b.net>0? 'ë°›ì„ ê¸ˆì•¡' : (b.net<0? 'ë³´ë‚¼ ê¸ˆì•¡':'ì •ì‚° ì™„ë£Œ');
      const color = b.net>0? 'badge' : (b.net<0? 'pill':'badge');
      item.innerHTML = `
        <div><strong>${escapeHTML(b.name)}</strong><div class="kicker">ì§€ë¶ˆ ${fmt(b.paid, currency)} Â· ì‚¬ìš© ${fmt(b.used, currency)}</div></div>
        <div class="row"><span class="${color}">${status}</span><div class="amount" style="min-width:110px;text-align:right">${fmt(b.net, currency)}</div></div>`;
      table.appendChild(item);
    })
    el.appendChild(table);

    el.appendChild(document.createElement('div')).className='divider';

    const st = document.createElement('div'); st.className='list';
    if(s.settlements.length===0){
      const ok = document.createElement('div'); ok.className='empty'; ok.textContent='ëª¨ë“  ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'; st.appendChild(ok);
    }else{
      s.settlements.forEach(x=>{
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `<div><strong>${escapeHTML(x.from)}</strong> â†’ <strong>${escapeHTML(x.to)}</strong></div><div class="amount">${fmt(x.amount, currency)}</div>`;
        st.appendChild(item);
      })
    }
    el.appendChild(st);
  }
  drawSummary();

}

function openExpenseEditor(t, expId){
  const e = t.expenses.find(x=>x.id===expId); if(!e) return;
  const modal = document.createElement('div');
  modal.className='modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <div class="card">
        <h3>ì§€ì¶œ ìˆ˜ì •</h3>
        <div class="grid cols-3">
          <div>
            <label>ë‚ ì§œ</label>
            <input type="date" id="edDate" value="${e.date||t.start||''}" />
          </div>
          <div>
            <label>í•­ëª©</label>
            <input id="edTitle" value="${escapeAttr(e.title)}" />
          </div>
          <div>
            <label>ê¸ˆì•¡ (${t.currency||'KRW'})</label>
            <input id="edAmount" inputmode="decimal" value="${e.amount}" />
          </div>
          <div style="grid-column:1 / -1">
            <label>ë©”ëª¨ (ì„ íƒ)</label>
            <textarea id="edMemo" rows="3" placeholder="ì¥ì†Œ, ì˜ìˆ˜ì¦ ë²ˆí˜¸, ë¹„ê³  ë“±">${escapeHTML(e.memo||'')}</textarea>
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <div>
            <label>ì§€ë¶ˆì</label>
            <select id="edPayer">${t.people.map(p=>`<option value="${p.id}">${escapeHTML(p.name)}</option>`).join('')}</select>
          </div>
          <div class="colspan-2">
            <label>ì‚¬ìš©í•œ ì‚¬ëŒ / ë¶„ë°° ëŒ€ìƒ</label>
            <div id="edUsers" class="chips"></div>
          </div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:12px">
          <button class="btn danger" id="delBtn" type="button">ì‚­ì œ</button>
          <div class="row">
            <button class="btn ghost" id="cancelBtn" type="button">ì·¨ì†Œ</button>
            <button class="btn primary" id="saveBtn" type="button">ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>`;
  document.body.appendChild(modal);
  enableAutoShowDatePickers(modal);

  // ì´ˆê¸°ê°’ ì„¤ì •
  modal.querySelector('#edPayer').value = e.paidBy;
  const usersWrap = modal.querySelector('#edUsers');
  const userSet = new Set(e.users||[]);
  (t.people||[]).forEach(p=>{
    const c = document.createElement('div');
    c.className='chip'; c.textContent=p.name; c.dataset.id=p.id;
    if(userSet.has(p.id)) c.classList.add('active');
    c.onclick=()=> c.classList.toggle('active');
    usersWrap.appendChild(c);
  });

  function close(){ modal.remove(); }

  modal.querySelector('#cancelBtn').onclick = close;
  modal.querySelector('#delBtn').onclick = async ()=>{
    const ok = await askConfirm('ì´ ì§€ì¶œì„ ì‚­ì œí• ê¹Œìš”?', 'ì‚­ì œ', 'ì·¨ì†Œ');
    if(!ok) return;
    t.expenses = t.expenses.filter(x=>x.id!==e.id);
    save(); close(); openTrip(t.id);
  };
  modal.querySelector('#saveBtn').onclick = ()=>{
    const date = modal.querySelector('#edDate').value;
    const title = modal.querySelector('#edTitle').value.trim();
    const amount = parseFloat(modal.querySelector('#edAmount').value);
    const paidBy = modal.querySelector('#edPayer').value;
    const users = [...modal.querySelectorAll('#edUsers .chip.active')].map(x=>x.dataset.id);
    const memo = modal.querySelector('#edMemo').value.trim();
    if(!title || !amount || !paidBy || users.length===0){ alert('í•­ëª©/ê¸ˆì•¡/ì§€ë¶ˆì/ì‚¬ìš©ì(ë¶„ë°° ëŒ€ìƒ)ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return }
    e.date = date; e.title = title; e.amount = amount; e.paidBy = paidBy; e.users = users; e.memo = memo;
    save(); close(); openTrip(t.id);
  };
}

// ===== ê³„ì‚° ë¡œì§ =====
function calcTripStats(t){
  const currency = t.currency||'KRW';
  const people = t.people;
  const totalsUsed = Object.fromEntries(people.map(p=>[p.id,0]));
  const totalsPaid = Object.fromEntries(people.map(p=>[p.id,0]));
  let totalAmount = 0; let totalShares = 0; // ì‚¬ìš©ì ìˆ˜ ê¸°ë°˜ í‰ê·  ê³„ì‚°ìš©

  (t.expenses||[]).forEach(e=>{
    const n = e.users.length;
    if(!n) return;
    const share = e.amount / n;
    totalAmount += e.amount;
    totalShares += n;
    totalsPaid[e.paidBy] = (totalsPaid[e.paidBy]||0) + e.amount;
    e.users.forEach(id=>{ totalsUsed[id] = (totalsUsed[id]||0) + share; });
  });

  const balances = people.map(p=>{
    const paid = round2(totalsPaid[p.id]||0);
    const used = round2(totalsUsed[p.id]||0);
    return { id:p.id, name:p.name, paid, used, net: round2(paid - used) };
  });

  // ì •ì‚° ì œì•ˆ (ê·¸ë¦¬ë””)
  const debtors = balances.filter(b=>b.net< -0.005).map(b=>({name:b.name, id:b.id, amount: -b.net})).sort((a,b)=>b.amount-a.amount);
  const creditors = balances.filter(b=>b.net> 0.005).map(b=>({name:b.name, id:b.id, amount: b.net})).sort((a,b)=>b.amount-a.amount);
  const settlements = [];
  let i=0, j=0;
  while(i<debtors.length && j<creditors.length){
    const d = debtors[i], c = creditors[j];
    const amt = Math.min(d.amount, c.amount);
    if(amt>0.004){
      settlements.push({from:d.name, to:c.name, amount: round2(amt)});
    }
    d.amount = round2(d.amount - amt);
    c.amount = round2(c.amount - amt);
    if(d.amount<=0.004) i++;
    if(c.amount<=0.004) j++;
  }

  const avgUsers = new Set((t.expenses||[]).flatMap(e=>e.users)).size || people.length || 1;
  const avgPerUser = round2(totalShares? totalAmount / avgUsers : 0);

  return { currency, totalAmount: round2(totalAmount), avgPerUser, balances, settlements };
}

function round2(n){ return Math.round((Number(n)||0)*100)/100 }

// ===== ê³µìœ  ë° ìš”ì•½ í…ìŠ¤íŠ¸ =====
function buildSummaryText(t){
  const s = calcTripStats(t);
  const peopleList = t.people.map(p=>p.name).join(', ');
  const lines = [];
  lines.push(`ğŸ“Œ ì—¬í–‰ ì •ì‚° â€” ${t.name}${t.type? ' ('+t.type+')':''}`);
  if(t.start || t.end){ lines.push(`ê¸°ê°„: ${t.start||''} ~ ${t.end||''}`) }
  lines.push(`ì°¸ê°€ì: ${peopleList}`);
  lines.push('');
  lines.push(`ì´ì•¡: ${fmtPlain(s.totalAmount)}`);
  lines.push(`ì§€ì¶œ ${t.expenses.length}ê±´`);
  lines.push('');
  lines.push('â€” ê°œì¸ë³„ ì •ì‚°');
  s.balances.forEach(b=>{
    const tag = b.net>0? 'ë°›ì„ ê¸ˆì•¡' : (b.net<0? 'ë³´ë‚¼ ê¸ˆì•¡':'ì •ì‚° ì™„ë£Œ');
    lines.push(`â€¢ ${b.name}: ì§€ë¶ˆ ${fmtPlain(b.paid)}, ì‚¬ìš© ${fmtPlain(b.used)}, ${tag} ${fmtPlain(b.net)}`);
  })
  lines.push('');
  if(s.settlements.length){
    lines.push('â€” ì†¡ê¸ˆ ì œì•ˆ');
    s.settlements.forEach(x=> lines.push(`â€¢ ${x.from} â†’ ${x.to}: ${fmtPlain(x.amount)}`));
  }else{
    lines.push('â€” ëª¨ë“  ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
  lines.push('');
  lines.push('ì„¸ë¶€ ì§€ì¶œ');
  (t.expenses||[]).forEach(e=>{
    const users = e.users.map(id=> t.people.find(p=>p.id===id)?.name).filter(Boolean).join(', ');
    const payer = t.people.find(p=>p.id===e.paidBy)?.name || '';
    const memoOne = (e.memo||'').replace(/\n/g,' ').trim();
    lines.push(`â€¢ ${e.date||''} ${e.title}: ${fmtPlain(e.amount)} (ì§€ë¶ˆì ${payer}, ì‚¬ìš©: ${users})${memoOne? ' â€” ë©”ëª¨: '+memoOne : ''}`);
  })
  return lines.join('\n');
}

function buildChatMessage(t){
  const s = calcTripStats(t);
  const peopleCnt = t.people.length;
  const signed = (n)=> (n>0?'+':'') + fmtPlain(n);
  const lines = [];
  // 1~2ì¤„: ì œëª©/ê¸°ê°„
  lines.push(`[ì •ì‚°] ${t.name}${t.type?`/${t.type}`:''}`);
  if(t.start || t.end){ lines.push(`${t.start||''}${t.end?`~${t.end}`:''}`); }
  // 3ì¤„: ì´ì•¡/ê±´ìˆ˜/ì¸ì› (í†µí™” ë‹¨ìœ„ ì œê±°)
  lines.push(`ì´ì•¡ ${fmtPlain(s.totalAmount)} Â· ì§€ì¶œ ${t.expenses.length}ê±´ Â· ${peopleCnt}ëª…`);
  // 4ì¤„: ì •ì‚° ì œì•ˆ ìš”ì•½
  if(s.settlements.length){
    lines.push('ì •ì‚° ' + s.settlements.map(x=>`${x.from}->${x.to} ${fmtPlain(x.amount)}`).join(' Â· '));
  }else{
    lines.push('ì •ì‚° ì™„ë£Œ');
  }
  // 5ì¤„: ê°œì¸ë³„ ìˆœì•¡ ìš”ì•½
  lines.push('ê°œì¸ ' + s.balances.map(b=>`${b.name} ${signed(b.net)}`).join(', '));
  return lines.join('\n');
}

async function copySummary(){
  const t = getCurrentTrip(); if(!t){ alert('ì—¬í–‰ì„ ë¨¼ì € ì—¬ì„¸ìš”.'); return }
  const text = buildSummaryText(t);
  try{
    await navigator.clipboard.writeText(text);
    alert('ìš”ì•½ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ì±„íŒ…ë°©ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
  }catch(e){
    // fallback: ìˆ˜ë™ ë³µì‚¬ ëª¨ë‹¬
    const modal = document.createElement('div');
    modal.className='modal-backdrop';
    modal.innerHTML = `<div class="modal"><div class="card"><h3>ë³µì‚¬ ì‹¤íŒ¨</h3><div class="hint">ì•„ë˜ ë‚´ìš©ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.</div><textarea style="width:100%;height:220px;margin-top:8px">${escapeHTML(text)}</textarea><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" id="closeCopy" type="button">ë‹«ê¸°</button></div></div></div>`;
    document.body.appendChild(modal);
    modal.querySelector('#closeCopy').onclick = ()=> modal.remove();
  }
}

async function copyChatMessage(){
  const t = getCurrentTrip(); if(!t){ alert('ì—¬í–‰ì„ ë¨¼ì € ì—¬ì„¸ìš”.'); return }
  const text = buildChatMessage(t);
  try{
    await navigator.clipboard.writeText(text);
    alert('ì¹´ì¹´ì˜¤/ë¬¸ììš© í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ì±„íŒ…ë°©ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
  }catch(e){
    const modal = document.createElement('div');
    modal.className='modal-backdrop';
    modal.innerHTML = `<div class="modal"><div class="card"><h3>ë³µì‚¬ ì‹¤íŒ¨</h3><div class="hint">ì•„ë˜ ë‚´ìš©ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.</div><textarea style="width:100%;height:220px;margin-top:8px">${escapeHTML(text)}</textarea><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" id="closeCopy2" type="button">ë‹«ê¸°</button></div></div></div>`;
    document.body.appendChild(modal);
    modal.querySelector('#closeCopy2').onclick = ()=> modal.remove();
  }
}

async function shareSummary(){
  const t = getCurrentTrip(); if(!t){ alert('ì—¬í–‰ì„ ë¨¼ì € ì—¬ì„¸ìš”.'); return }
  const text = buildSummaryText(t);
  if(navigator.share){
    try{ await navigator.share({title:`ì—¬í–‰ ì •ì‚° â€” ${t.name}`, text}); }
    catch(e){ /* ì‚¬ìš©ì ì·¨ì†Œ ë“± ë¬´ì‹œ */ }
  }else{
    await copySummary();
  }
}

async function shareChat(){
  const t = getCurrentTrip(); if(!t){ alert('ì—¬í–‰ì„ ë¨¼ì € ì—¬ì„¸ìš”.'); return }
  const text = buildChatMessage(t);
  if(navigator.share){
    try{ await navigator.share({title:`ì •ì‚° â€” ${t.name}`, text}); }
    catch(e){ /* ì·¨ì†Œ ë“± ë¬´ì‹œ */ }
  }else{
    await copyChatMessage();
  }
}

// ===== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ (êµ¬ê¸€ì‹œíŠ¸) ì—°ë™: TSV/CSV + ì§ì ‘ ì“°ê¸° =====
const SHEETS_CFG_KEY = 'travelSplitSheetsCfg_v1';
let gsTokenClient = null, gsAccessToken = null, gsTokenExpiry = 0, gsClientIdMemo = null;

function loadSheetsCfg(){ try{ return JSON.parse(localStorage.getItem(SHEETS_CFG_KEY))||{} }catch(e){ return {} } }
function saveSheetsCfg(cfg){ localStorage.setItem(SHEETS_CFG_KEY, JSON.stringify(cfg)); }

function ensureGIS(){
  return new Promise((resolve, reject)=>{
    if(window.google && google.accounts && google.accounts.oauth2){ resolve(); return; }
    const s = document.createElement('script');
    s.src='https://accounts.google.com/gsi/client';
    s.async = true; s.defer = true;
    s.onload = ()=> resolve();
    s.onerror = ()=> reject(new Error('Google Identity Services ë¡œë“œ ì‹¤íŒ¨'));
    document.head.appendChild(s);
  });
}

function initGsTokenClient(clientId){
  gsClientIdMemo = clientId;
  gsTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    callback: (resp)=>{
      if(resp.error){ console.error(resp); alert('í† í° ë°œê¸‰ ì‹¤íŒ¨: '+resp.error); return; }
      gsAccessToken = resp.access_token;
      gsTokenExpiry = Date.now() + ((resp.expires_in||3600)-60)*1000; // 1ë¶„ ì—¬ìœ 
      console.log('Sheets í† í° í™•ë³´');
    }
  });
}

function tokenValid(){ return gsAccessToken && Date.now() < gsTokenExpiry; }

async function getGsToken(clientId, promptConsent){
  await ensureGIS();
  if(!gsTokenClient || gsClientIdMemo!==clientId){ initGsTokenClient(clientId); }
  return new Promise(resolve=>{
    gsTokenClient.callback = (resp)=>{
      if(resp && resp.access_token){
        gsAccessToken = resp.access_token;
        gsTokenExpiry = Date.now()+((resp.expires_in||3600)-60)*1000;
        resolve(gsAccessToken);
      }else{ resolve(null); }
    };
    gsTokenClient.requestAccessToken({ prompt: promptConsent? 'consent' : 'none' });
  });
}

async function appendRowsToGoogleSheet({clientId, sheetId, sheetName, rows}){
  // í† í° í™•ë³´ (ê°€ëŠ¥í•˜ë©´ ì¡°ìš©íˆ, ì‹¤íŒ¨ ì‹œ ë™ì˜ì°½)
  let token = tokenValid()? gsAccessToken : await getGsToken(clientId, false);
  if(!token){ token = await getGsToken(clientId, true); }
  if(!token){ throw new Error('Google ì¸ì¦ ì‹¤íŒ¨'); }

  const range = encodeURIComponent(`${sheetName||'Sheet1'}!A1`);
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`;
  const payload = { range: `${sheetName||'Sheet1'}!A1`, majorDimension:'ROWS', values: rows };
  const resp = await fetch(url, { method:'POST', headers:{ 'Authorization': 'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  if(!resp.ok){ const text = await resp.text(); throw new Error(`Google API ì˜¤ë¥˜ ${resp.status}: ${text}`); }
  return await resp.json();
}

function openSheetExportModal(){
  const wrap = document.createElement('div');
  wrap.className='modal-backdrop';
  const cfg = loadSheetsCfg();
  wrap.innerHTML = `
    <div class="modal">
      <div class="card">
        <h3>êµ¬ê¸€ì‹œíŠ¸ ì—°ë™</h3>
        <div class="kicker">ì•„ë˜ ë‘ ê°€ì§€ ë°©ì‹ ì¤‘ ì„ íƒí•˜ì„¸ìš”.</div>
        <div class="divider"></div>
        <div>
          <h4 style="margin:0 0 8px">â‘  ë³µì‚¬/ë‹¤ìš´ë¡œë“œ í›„ ë¶™ì—¬ë„£ê¸°</h4>
          <label>í–‰ êµ¬ì„±</label>
          <div class="row">
            <label class="chip"><input type="radio" name="sheetMode" value="trip" checked style="margin-right:6px"> ì—¬í–‰ë³„ 1í–‰</label>
            <label class="chip"><input type="radio" name="sheetMode" value="expense" style="margin-right:6px"> ì§€ì¶œë³„ ì—¬ëŸ¬í–‰</label>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn" id="shCopyTSV" type="button">TSV ë³µì‚¬(êµ¬ê¸€ì‹œíŠ¸ìš©)</button>
            <button class="btn" id="shDownloadCSV" type="button">CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
        <div class="divider"></div>
        <div>
          <h4 style="margin:0 0 8px">â‘¡ ì§ì ‘ ì“°ê¸°(ë² íƒ€ Â· OAuth í•„ìš”)</h4>
          <div class="hint" style="margin:6px 0">HTTPSë¡œ í˜¸ìŠ¤íŒ…ëœ ì£¼ì†Œì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤(íŒŒì¼ ì§ì ‘ ì—´ê¸° X). êµ¬ê¸€ í´ë¼ìš°ë“œ ì½˜ì†”ì˜ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ì— í˜„ì¬ URLì„ <b>ìŠ¹ì¸ëœ JavaScript ì›ë³¸</b>ìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.</div>
          <div class="grid cols-3">
            <div>
              <label>OAuth í´ë¼ì´ì–¸íŠ¸ ID</label>
              <input id="gsClientId" placeholder="...apps.googleusercontent.com" value="${escapeAttr(cfg.clientId||'')}" />
            </div>
            <div>
              <label>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
              <input id="gsSheetId" placeholder="ì‹œíŠ¸ URLì˜ /d/ ì™€ /edit ì‚¬ì´" value="${escapeAttr(cfg.sheetId||'')}" />
            </div>
            <div>
              <label>ì‹œíŠ¸ ì´ë¦„</label>
              <input id="gsSheetName" placeholder="Sheet1" value="${escapeAttr(cfg.sheetName||'Sheet1')}" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <label class="chip"><input type="radio" name="sheetMode2" value="trip" checked> ì—¬í–‰ë³„ 1í–‰</label>
            <label class="chip"><input type="radio" name="sheetMode2" value="expense"> ì§€ì¶œë³„ ì—¬ëŸ¬í–‰</label>
            <label class="chip"><input type="checkbox" id="gsWithHeader" checked> í—¤ë” í¬í•¨</label>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn" id="gsLoginBtn" type="button">ë¡œê·¸ì¸/ê¶Œí•œ ìš”ì²­</button>
            <button class="btn primary" id="gsAppendBtn" type="button">ì‹œíŠ¸ì— Append</button>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" id="shClose" type="button">ë‹«ê¸°</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(wrap);

  const close = ()=> wrap.remove();
  wrap.querySelector('#shClose').onclick = close;

  const getMode = ()=> (wrap.querySelector('input[name="sheetMode"]:checked')?.value || 'trip');
  wrap.querySelector('#shCopyTSV').onclick = async ()=>{
    const rows = buildSheetRows(getMode());
    const tsv = rowsToTSV(rows);
    try{ await navigator.clipboard.writeText(tsv); alert('TSVë¥¼ ë³µì‚¬í–ˆì–´ìš”. êµ¬ê¸€ì‹œíŠ¸ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.'); }
    catch(e){ showCopyFallback(tsv); }
  };
  wrap.querySelector('#shDownloadCSV').onclick = ()=>{
    const rows = buildSheetRows(getMode());
    const csv = rowsToCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='trips.csv'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
  };

  // ì§ì ‘ ì“°ê¸° ë°”ì¸ë”©
  const $ = (sel)=> wrap.querySelector(sel);
  const clientIdEl = $('#gsClientId');
  const sheetIdEl = $('#gsSheetId');
  const sheetNameEl = $('#gsSheetName');
  const withHeaderEl = $('#gsWithHeader');
  const getMode2 = ()=> (wrap.querySelector('input[name="sheetMode2"]:checked')?.value || 'trip');

  const saveCfgNow = ()=> saveSheetsCfg({ clientId: clientIdEl.value.trim(), sheetId: sheetIdEl.value.trim(), sheetName: sheetNameEl.value.trim()||'Sheet1' });
  clientIdEl.addEventListener('change', saveCfgNow);
  sheetIdEl.addEventListener('change', saveCfgNow);
  sheetNameEl.addEventListener('change', saveCfgNow);

  $('#gsLoginBtn').onclick = async ()=>{
    try{
      await ensureGIS();
      initGsTokenClient(clientIdEl.value.trim());
      await getGsToken(clientIdEl.value.trim(), true);
      alert('êµ¬ê¸€ ì¸ì¦ ì™„ë£Œ. ì´ì œ "ì‹œíŠ¸ì— Append"ë¥¼ ëˆŒëŸ¬ ì „ì†¡í•˜ì„¸ìš”.');
    }catch(err){ alert('ì¸ì¦ ì´ˆê¸°í™” ì‹¤íŒ¨: '+err.message); }
  };

  $('#gsAppendBtn').onclick = async ()=>{
    try{
      const mode = getMode2();
      let rows = buildSheetRows(mode);
      if(!withHeaderEl.checked){ rows = rows.slice(1); }
      const res = await appendRowsToGoogleSheet({
        clientId: clientIdEl.value.trim(),
        sheetId: sheetIdEl.value.trim(),
        sheetName: sheetNameEl.value.trim()||'Sheet1',
        rows
      });
      alert('ì‹œíŠ¸ì— ì „ì†¡ ì™„ë£Œ! (ì—…ë°ì´íŠ¸ ë²”ìœ„: '+ (res.updates?.updatedRange||'ì•Œ ìˆ˜ ì—†ìŒ') +')');
    }catch(err){
      console.error(err);
      alert('ì „ì†¡ ì‹¤íŒ¨: '+ err.message + '\n\nÂ· HTTPSì—ì„œ ì—´ì—ˆëŠ”ì§€\nÂ· OAuth í´ë¼ì´ì–¸íŠ¸ì— í˜„ì¬ ë„ë©”ì¸ì´ ë“±ë¡ëëŠ”ì§€\nÂ· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID/ì´ë¦„ì´ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”.');
    }
  };
}

function buildSheetRows(mode='trip'){
  const rows = [];
  // í—¤ë” ê³ ì •: ì—¬í–‰ ë‚ ì§œ, ì—¬í–‰ ì´ë¦„, ì°¸ê°€ì, ì§€ì¶œë‚´ì—­, ì´ ì§€ì¶œ
  rows.push(['ì—¬í–‰ ë‚ ì§œ','ì—¬í–‰ ì´ë¦„','ì°¸ê°€ì','ì§€ì¶œë‚´ì—­','ì´ ì§€ì¶œ']);
  const trips = App.state.trips || [];
  const dateStr = (t)=> (t.start||t.end)? `${t.start||''}${t.end?`~${t.end}`:''}` : '';
  const joinNames = (arr)=> (arr||[]).map(x=>x.name).join(', ');
  const userNames = (t, ids)=> ids.map(id=> t.people.find(p=>p.id===id)?.name).filter(Boolean).join(', ');
  if(mode==='trip'){
    trips.forEach(t=>{
      const s = calcTripStats(t);
      const expStr = (t.expenses||[]).map(e=>{
        const payer = t.people.find(p=>p.id===e.paidBy)?.name || '';
        const users = userNames(t, e.users);
        const memo = (e.memo||'').replace(/\n/g,' ').trim();
        return `${e.date||''} ${e.title} ${fmtPlain(e.amount)} (ì§€ë¶ˆì ${payer}, ì‚¬ìš©: ${users}${memo?`, ë©”ëª¨: ${memo}`:''})`;
      }).join(' | ');
      rows.push([dateStr(t), t.name||'', joinNames(t.people), expStr, fmtPlain(s.totalAmount)]);
    });
  }else{ // expense rows
    trips.forEach(t=>{
      const s = calcTripStats(t);
      (t.expenses||[]).forEach(e=>{
        const payer = t.people.find(p=>p.id===e.paidBy)?.name || '';
        const users = userNames(t, e.users);
        const memo = (e.memo||'').replace(/\n/g,' ').trim();
        const expStr = `${e.date||''} ${e.title} ${fmtPlain(e.amount)} (ì§€ë¶ˆì ${payer}, ì‚¬ìš©: ${users}${memo?`, ë©”ëª¨: ${memo}`:''})`;
        rows.push([dateStr(t), t.name||'', joinNames(t.people), expStr, fmtPlain(s.totalAmount)]);
      })
      if((t.expenses||[]).length===0){
        rows.push([dateStr(t), t.name||'', joinNames(t.people), '', fmtPlain(calcTripStats(t).totalAmount)]);
      }
    });
  }
  return rows;
}

function rowsToTSV(rows){
  return rows.map(r=> r.map(v=> String(v).replace(/\t/g,' ').replace(/\r?\n/g,' ')).join('\t')).join('\n');
}
function rowsToCSV(rows){
  const esc = (s)=>{
    const str = String(s);
    if(/[",\n]/.test(str)) return '"'+str.replace(/"/g,'""')+'"';
    return str;
  };
  return rows.map(r=> r.map(esc).join(',')).join('\n');
}
function showCopyFallback(text){
  const modal = document.createElement('div');
  modal.className='modal-backdrop';
  modal.innerHTML = `<div class="modal"><div class="card"><h3>ë³µì‚¬ ì‹¤íŒ¨</h3><div class="hint">ì•„ë˜ ë‚´ìš©ì„ ì„ íƒí•´ ë³µì‚¬í•˜ì„¸ìš”.</div><textarea style="width:100%;height:220px;margin-top:8px">${escapeHTML(text)}</textarea><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" id="closeSheetCopy" type="button">ë‹«ê¸°</button></div></div></div>`;
  document.body.appendChild(modal);
  modal.querySelector('#closeSheetCopy').onclick = ()=> modal.remove();
}

// ===== ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° =====
function exportJSON(){
  const dataStr = JSON.stringify(App.state, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`travel-split-backup.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
}

function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = function(e){
    try{ const obj = JSON.parse(e.target.result);
      if(!obj || !obj.trips){ alert('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.'); return }
      App.state = obj; save(); renderTrips();
    }catch(err){ alert('ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
  };
  reader.readAsText(file);
}

function getCurrentTrip(){ return App.state.trips.find(t=>t.id===App.currentTripId) || App.state.trips[0] }

// ===== ê³µìš© UI ì´ë²¤íŠ¸ =====
function escapeHTML(str){ return (str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])) }
function escapeAttr(str){ return escapeHTML(str).replace(/\n/g,' ') }

// ì‚¬ìš©ì ì •ì˜ í™•ì¸ ëª¨ë‹¬ (ì¼ë¶€ í™˜ê²½ì—ì„œ window.confirm ì°¨ë‹¨ ëŒ€ë¹„)
function askConfirm(message, okLabel='í™•ì¸', cancelLabel='ì·¨ì†Œ'){
  return new Promise(resolve=>{
    const wrap = document.createElement('div');
    wrap.className = 'modal-backdrop';
    wrap.innerHTML = `
      <div class="modal">
        <div class="card">
          <h3>í™•ì¸</h3>
          <div class="hint" style="margin:6px 0 12px">${escapeHTML(message)}</div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn ghost" id="cfCancel" type="button">${escapeHTML(cancelLabel)}</button>
            <button class="btn danger" id="cfOk" type="button">${escapeHTML(okLabel)}</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(wrap);
    const onDone = v=>{ cleanup(); resolve(v) };
    const cleanup = ()=>{
      document.removeEventListener('keydown', onKey);
      wrap.remove();
    };
    const onKey = (e)=>{
      if(e.key==='Escape'){ onDone(false); }
      if(e.key==='Enter'){ onDone(true); }
    };
    document.addEventListener('keydown', onKey);
    wrap.querySelector('#cfCancel').onclick = ()=> onDone(false);
    wrap.querySelector('#cfOk').onclick = ()=> onDone(true);
    // ë°”ê¹¥ í´ë¦­ ì·¨ì†Œ
    wrap.addEventListener('click', (e)=>{ if(e.target===wrap) onDone(false); });
  });
}

// ë‚ ì§œ ì…ë ¥ ìë™ ë‹¬ë ¥ í‘œì‹œ (ì§€ì› ë¸Œë¼ìš°ì €ì—ì„œ showPicker ì‚¬ìš©)
function enableAutoShowDatePickers(scope=document){
  const inputs = scope.querySelectorAll('input[type="date"]');
  inputs.forEach(inp=>{
    if(inp.dataset.pickerBound) return; // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
    const open = () => {
      if(typeof inp.showPicker === 'function'){
        try{ inp.showPicker(); }catch(e){ /* ì¼ë¶€ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì œì•½ ë“± ë¬´ì‹œ */ }
      }
    };
    inp.addEventListener('focus', open);
    inp.addEventListener('click', open);
    inp.dataset.pickerBound = '1';
  });
}

// FAB ë™ì‘: ëª©ë¡ì—ì„  ìƒˆ ì—¬í–‰, ìƒì„¸ì—ì„  ìƒˆ ì§€ì¶œ í¬ì»¤ìŠ¤
function setupFAB(){
  const btn = document.getElementById('btnAdd');
  btn.onclick = ()=>{
    const tripVisible = document.getElementById('screenTrip').style.display!=='none';
    if(tripVisible){
      // ì§€ì¶œ ì…ë ¥ ë°”ë¡œ í¬ì»¤ìŠ¤
      document.getElementById('eTitle')?.focus();
    }else{
      // ìƒˆ ì—¬í–‰ ìƒì„±
      const id = uid();
      App.state.trips.push({id, name:'ìƒˆ ì—¬í–‰', type:'', currency:'KRW', start:'', end:'', people:[], expenses:[]});
      save(); openTrip(id);
    }
  }
}

// ===== ë‚´ì¥ í…ŒìŠ¤íŠ¸ =====
function runSelfTests(){
  const assert = (name, cond) => console[cond? 'log':'error'](`${cond?'âœ…':'âŒ'} ${name}`);
  // TC1: 3ì¸ ê· ë“± ë¶„ë°° 30,000ì› (Aê°€ ê²°ì œ)
  const A={id:'A',name:'A'},B={id:'B',name:'B'},C={id:'C',name:'C'};
  const trip1={currency:'KRW', people:[A,B,C], expenses:[{amount:30000, paidBy:'A', users:['A','B','C']}]};
  const s1 = calcTripStats(trip1);
  console.log('--- Self Tests Start ---');
  assert('TC1 ì´ì•¡=30000', s1.totalAmount===30000);
  const bA1 = s1.balances.find(x=>x.id==='A'), bB1=s1.balances.find(x=>x.id==='B'), bC1=s1.balances.find(x=>x.id==='C');
  assert('TC1 A ìˆœì•¡ +20000', bA1.net===20000);
  assert('TC1 B ìˆœì•¡ -10000', bB1.net===-10000);
  assert('TC1 C ìˆœì•¡ -10000', bC1.net===-10000);
  assert('TC1 ì •ì‚° 2ê±´', s1.settlements.length===2);

  // TC2: ì‚¬ìš©ì ì¼ë¶€ë§Œ ì‚¬ìš©(ë‘ ëª…)
  const trip2={currency:'KRW', people:[A,B,C], expenses:[{amount:9000, paidBy:'B', users:['A','B']}]};
  const s2 = calcTripStats(trip2);
  assert('TC2 ì´ì•¡=9000', s2.totalAmount===9000);
  const bB2 = s2.balances.find(x=>x.id==='B'), bA2=s2.balances.find(x=>x.id==='A'), bC2=s2.balances.find(x=>x.id==='C');
  assert('TC2 B ìˆœì•¡ +4500', bB2.net===4500);
  assert('TC2 A ìˆœì•¡ -4500', bA2.net===-4500);
  assert('TC2 C ìˆœì•¡ 0', bC2.net===0);

  // TC3: ì„œë¡œ ë‹¤ë¥¸ ì‚¬ëŒì´ ê°ê° ê²°ì œí•˜ì—¬ ì™„ì „ ìƒì‡„ë˜ëŠ” ê²½ìš° (ì •ì‚° 0ê±´)
  const trip3={currency:'KRW', people:[A,B], expenses:[
    {amount:10000, paidBy:'A', users:['A','B']},
    {amount:10000, paidBy:'B', users:['A','B']}
  ]};
  const s3=calcTripStats(trip3);
  assert('TC3 ì´ì•¡=20000', s3.totalAmount===20000);
  const bA3=s3.balances.find(x=>x.id==='A'), bB3=s3.balances.find(x=>x.id==='B');
  assert('TC3 A ìˆœì•¡ 0', bA3.net===0);
  assert('TC3 B ìˆœì•¡ 0', bB3.net===0);
  assert('TC3 ì •ì‚° 0ê±´', s3.settlements.length===0);

  // TC4: ì†Œìˆ˜ì  ê¸ˆì•¡ê³¼ ë¼ìš´ë”© ì²´í¬ (10001ì›ì„ 3ëª…ì´ ì‚¬ìš©)
  const trip4={currency:'KRW', people:[A,B,C], expenses:[{amount:10001, paidBy:'C', users:['A','B','C']}]};
  const s4=calcTripStats(trip4);
  assert('TC4 ì´ì•¡=10001', s4.totalAmount===10001);
  const bC4=s4.balances.find(x=>x.id==='C');
  assert('TC4 C ìˆœì•¡ ì•½ 6667.67', Math.abs(bC4.net-6667.67)<0.01);

  // TC5: ë¹ˆ ì§€ì¶œ/ì°¸ê°€ìë§Œ ìˆëŠ” ê²½ìš°
  const trip5={currency:'KRW', people:[A,B,C], expenses:[]};
  const s5=calcTripStats(trip5);
  assert('TC5 ì´ì•¡=0', s5.totalAmount===0);
  const bA5=s5.balances.find(x=>x.id==='A');
  assert('TC5 A ìˆœì•¡ 0', bA5.net===0);

  // TC6: ë‘ ëª…ì´ í•œ ëª…ì—ê²Œ ì†¡ê¸ˆí•´ì•¼ í•˜ëŠ” ì¼€ì´ìŠ¤ (ì •í™•í•œ ì†¡ê¸ˆ ì œì•ˆ)
  const trip6={currency:'KRW', people:[A,B,C], expenses:[
    {amount:12000, paidBy:'A', users:['A','B','C']}, // ê° 4000 ì‚¬ìš©, A +8000
    {amount:3000, paidBy:'B', users:['A','B']},     // ê° 1500 ì‚¬ìš©, B +1500, A -1500
  ]};
  const s6=calcTripStats(trip6);
  assert('TC6 ì •ì‚°ì•ˆ 2ê±´', s6.settlements.length===2);
  // ì´ ì •ì‚° ê¸ˆì•¡ í•©ì€ Aì˜ ìˆœì´ìµê³¼ ê°™ì•„ì•¼ í•¨
  const gainA = s6.balances.find(x=>x.id==='A').net;
  const sumSettle = s6.settlements.reduce((a,b)=>a+b.amount,0);
  assert('TC6 ì •ì‚° ì´í•© = A ì´ìµ', Math.abs(gainA - sumSettle) < 0.01);

  // TC7: ê·¹ì†Œ ê¸ˆì•¡(ì„ê³„ê°’)ì—ì„œ ì†¡ê¸ˆ ì œì•ˆì´ ìƒê¸°ì§€ ì•ŠìŒ (0.004 ì´í•˜ëŠ” ë¬´ì‹œ)
  const trip7={currency:'KRW', people:[A,B], expenses:[{amount:0.01, paidBy:'A', users:['A','B']}]};
  const s7=calcTripStats(trip7);
  assert('TC7 ì •ì‚° 0ê±´(ì„ê³„ê°’ ë¬´ì‹œ)', s7.settlements.length===0);

  // TC8: ì¹´ì¹´ì˜¤/ë¬¸ì í¬ë§· - ì •ì‚° ì¡´ì¬ ì‹œ í™”ì‚´í‘œ í‘œê¸° í¬í•¨
  const msg1 = buildChatMessage({
    name:'T', type:'ì¹œêµ¬', currency:'KRW', start:'2025-01-01', end:'2025-01-02',
    people:[A,B,C],
    expenses:[{amount:30000, paidBy:'A', users:['A','B','C']}]
  });
  assert('TC8 í¬ë§·ì— "->" í¬í•¨', msg1.includes('->'));

  // TC9: ì¹´ì¹´ì˜¤/ë¬¸ì í¬ë§· - ì •ì‚° ì™„ë£Œ ë¬¸êµ¬
  const msg2 = buildChatMessage({
    name:'T2', type:'ê°€ì¡±', currency:'KRW', start:'2025-01-01', end:'2025-01-02',
    people:[A,B],
    expenses:[{amount:10000, paidBy:'A', users:['A','B']},{amount:10000, paidBy:'B', users:['A','B']}]
  });
  assert('TC9 í¬ë§·ì— ì •ì‚° ì™„ë£Œ í¬í•¨', msg2.includes('ì •ì‚° ì™„ë£Œ'));

  // TC10: ìš”ì•½/ë¬¸ì í¬ë§·ì— í†µí™”ì½”ë“œê°€ í¬í•¨ë˜ì§€ ì•Šì•„ì•¼ í•¨
  const msg3 = buildSummaryText({
    name:'T3', type:'ì¹œêµ¬', currency:'USD', people:[A,B], start:'2025-01-01', end:'2025-01-02',
    expenses:[{amount:1234.56, paidBy:'A', users:['A','B']}]
  });
  assert('TC10 ìš”ì•½ì— í†µí™”ì½”ë“œ ì—†ìŒ', !/\b(KRW|USD|EUR|JPY)\b/.test(msg3));

  const msg4 = buildChatMessage({
    name:'T4', type:'ì¹œêµ¬', currency:'KRW', people:[A,B], start:'2025-01-01', end:'2025-01-02',
    expenses:[{amount:5000, paidBy:'A', users:['A','B']}]
  });
  assert('TC11 ë¬¸ìì— í†µí™”ì½”ë“œ ì—†ìŒ', !/\b(KRW|USD|EUR|JPY)\b/.test(msg4));

  // TC12: ì‚­ì œ ë¡œì§ ìˆœìˆ˜ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
  const st = {version:1, trips:[{id:'X'},{id:'Y'},{id:'Z'}]};
  const st2 = removeTripById(st, 'Y');
  assert('TC12 ì‚­ì œ í›„ ê¸¸ì´ -1', st2.trips.length===2 && st2.trips.findIndex(t=>t.id==='Y')===-1);

  // TC13: ëª©ë¡ í‘œì‹œ ì´ë¦„ (ì¶œë°œì¼_ì—¬í–‰ì´ë¦„)
  const td = {start:'2025-12-31', name:'ì—°ë§'};
  assert('TC13 í‘œì‹œëª…', tripDisplayName(td)==='2025-12-31_ì—°ë§');

  // TC14: ë©”ëª¨ê°€ ìš”ì•½ í…ìŠ¤íŠ¸ì—ëŠ” í¬í•¨, ë¬¸ì í¬ë§·ì—ëŠ” ë¯¸í¬í•¨
  const tripM={name:'M', type:'ì¹œêµ¬', currency:'KRW', people:[A], expenses:[{amount:1000, paidBy:'A', users:['A'], title:'ì»¤í”¼', memo:'ICE, í…Œì´í¬ì•„ì›ƒ'}]};
  const sTxt = buildSummaryText(tripM);
  const sMsg = buildChatMessage(tripM);
  assert('TC14 ìš”ì•½ì— ë©”ëª¨ í¬í•¨', sTxt.includes('ë©”ëª¨: ICE, í…Œì´í¬ì•„ì›ƒ'));
  assert('TC14 ë¬¸ìì— ë©”ëª¨ ë¯¸í¬í•¨', !sMsg.includes('ICE, í…Œì´í¬ì•„ì›ƒ'));

  // TC15: ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸° - í—¤ë”/í–‰ìˆ˜(ì—¬í–‰ë³„)
  const stTrips={trips:[{name:'T1',start:'2025-01-01',end:'2025-01-02',people:[A,B],expenses:[{amount:1000,paidBy:'A',users:['A'],title:'a'}]}, {name:'T2',people:[A],expenses:[]}]};
  const bak = App.state; App.state=stTrips; const r1=buildSheetRows('trip'); App.state=bak;
  assert('TC15 í—¤ë” í¬í•¨ & 1í–‰/ì—¬í–‰', r1.length===1+stTrips.trips.length && r1[0][0]==='ì—¬í–‰ ë‚ ì§œ');

  // TC16: ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸° - ì°¸ê°€ì ì½¤ë§ˆ êµ¬ë¶„
  const rowT = r1[1];
  assert('TC16 ì°¸ê°€ì êµ¬ë¶„ì', rowT[2].includes(','));

  // TC17: ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸° - ì´ ì§€ì¶œ ìˆ«ì ì¼ì¹˜
  const totalT1 = calcTripStats(stTrips.trips[0]).totalAmount;
  assert('TC17 ì´ ì§€ì¶œ ì¼ì¹˜', parseInt(r1[1][4].replace(/,/g,''),10)===totalT1);

  console.log('--- Self Tests End ---');
}

// ===== ì´ˆê¸°í™” =====
function init(){
  load();
  if(App.state.trips.length===0){
    // ìƒ˜í”Œ ì—¬í–‰ (í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í¬í•¨)
    const tId = uid();
    const p1={id:uid(),name:'ë¯¼ìˆ˜'}, p2={id:uid(),name:'ì§€ì˜'}, p3={id:uid(),name:'í˜„ìš°'};
    App.state.trips.push({
      id:tId, name:'ìƒ˜í”Œ ì—¬í–‰', type:'ì¹œêµ¬', currency:'KRW', start:'2025-08-01', end:'2025-08-04',
      people:[p1,p2,p3],
      expenses:[
        {id:uid(), date:'2025-08-01', title:'ì ì‹¬', amount:30000, paidBy:p1.id, users:[p1.id,p2.id,p3.id]},
        {id:uid(), date:'2025-08-02', title:'íƒì‹œ', amount:18000, paidBy:p2.id, users:[p2.id,p3.id]}
      ]
    });
    save();
  }
  renderTrips();
  setupFAB();
  // ê³µìš© ë²„íŠ¼
  document.getElementById('btnAllTrips').onclick = renderTrips;
  document.getElementById('btnCopy').onclick = copySummary;
  document.getElementById('btnCopyChat').onclick = copyChatMessage;
  document.getElementById('btnShare').onclick = shareSummary;
  document.getElementById('btnChatShare').onclick = shareChat;
  document.getElementById('btnExport').onclick = exportJSON;
  document.getElementById('btnRunTests').onclick = runSelfTests;
  document.getElementById('btnSheet').onclick = openSheetExportModal;
  document.getElementById('importJson').addEventListener('change', (e)=>{
    const f = e.target.files?.[0]; if(f) importJSONFile(f);
    e.target.value='';
  })
}

function getCurrentTrip(){ return App.state.trips.find(t=>t.id===App.currentTripId) || App.state.trips[0] }

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
